#include "whitebox.h"
#include <stdio.h>
#include <string.h>

/*

# Generated using the following Python:

import numpy as np

scale_factor = 1.0
sample_resolution = 16 # in bits
num_samples = 1024

half = scale_factor*pow(2, sample_resolution - 1)
pack = lambda i, q: np.int32(i & 0xffff) | ((q & 0xffff) << 16)
unpack = lambda s: (np.int16(s & 0xffff), np.int16((s >> 16) & 0xffff))

t = np.arange(0, 2*np.pi, (2*np.pi) / num_samples)
i = np.array(np.ceil(np.cos(t)*(half-1)), dtype=np.int16)
q = np.array(np.ceil(np.sin(t)*(half-1)), dtype=np.int16)

lut = [pack(a, b) for a, b in zip(i, q)]
lut_str = ["%d" % j for j in lut]
print 'int32_t sincos_lut[] = {', ', '.join(lut_str), '};'
*/

uint32_t sincos_lut[] = { 32767, 13271039, 26443773, 39616506, 52789238, 65961968, 79134697, 92241889, 105414616, 118587342, 131760066, 144867253, 158039975, 171147159, 184319879, 197427061, 210534242, 223641421, 236748600, 249855777, 262962953, 276004592, 289046229, 302087866, 315129501, 328171135, 341212767, 354188863, 367164957, 380141050, 393117142, 406093233, 419003786, 431914338, 444824889, 457669903, 470580451, 483425463, 496270473, 509049946, 521829418, 534608888, 547388357, 560102290, 572816221, 585464614, 598178543, 610826934, 623409789, 635992642, 648575493, 661158344, 673675658, 686192970, 698644745, 711096519, 723482756, 735868992, 748255226, 760575924, 772896620, 785217315, 797406937, 809662094, 821851713, 833975796, 846099877, 858223957, 870282500, 882341042, 894334047, 906261515, 918188982, 930116447, 941978375, 953774767, 965571157, 977302010, 989032862, 1000698177, 1012363490, 1023963267, 1035497507, 1047031745, 1058500447, 1069969147, 1081372310, 1092709937, 1104047562, 1115319650, 1126591737, 1137798287, 1148939300, 1160014776, 1171090251, 1182100188, 1193110125, 1204054525, 1214933388, 1225746714, 1236560038, 1247307826, 1257990077, 1268672326, 1279289039, 1289840215, 1300325854, 1310811491, 1321231592, 1331586156, 1341875183, 1352164209, 1362387698, 1372545650, 1382638065, 1392664943, 1402691820, 1412653160, 1422548963, 1432379230, 1442143959, 1451908688, 1461607879, 1471241534, 1480809652, 1490312233, 1499749277, 1509186320, 1518492290, 1527798260, 1537038692, 1546213588, 1555322947, 1564366769, 1573345054, 1582323338, 1591170549, 1600017760, 1608733898, 1617450035, 1626100635, 1634685698, 1643205225, 1651659215, 1660047668, 1668370584, 1676627963, 1684819806, 1692946112, 1701006881, 1709067649, 1716997345, 1724861504, 1732660126, 1740458747, 1748126296, 1755728308, 1763330319, 1770801258, 1778206660, 1785546525, 1792820853, 1800095181, 1807238436, 1814316155, 1821328337, 1828274982, 1835156090, 1841971662, 1848721697, 1855340660, 1861959622, 1868513047, 1874935400, 1881357752, 1887649032, 1893874775, 1900100517, 1906195187, 1912224320, 1918187917, 1924085977, 1929852965, 1935619952, 1941321402, 1946891780, 1952396622, 1957835927, 1963209695, 1968517927, 1973760622, 1978937781, 1983983868, 1989029954, 1993944967, 1998794445, 2003578385, 2008296789, 2012884121, 2017471452, 2021927711, 2026318434, 2030643620, 2034903270, 2039097383, 2043160424, 2047157928, 2051155432, 2055021864, 2058757224, 2062492583, 2066096869, 2069701156, 2073174370, 2076516512, 2079858653, 2083135258, 2086280791, 2089360788, 2092375248, 2095258636, 2098142023, 2100894339, 2103581118, 2106202361, 2108758068, 2111182702, 2113541800, 2115835362, 2118063388, 2120160342, 2122257295, 2124223176, 2126123521, 2127892794, 2129662067, 2131300268, 2132872932, 2134380060, 2135756116, 2137132172, 2138377156, 2139556604, 2140604979, 2141653355, 2142570658, 2143422426, 2144208657, 2144863816, 2145453439, 2145977527, 2146436078, 2146829093, 2147091036, 2147287443, 2147418314, 2147418113, 2147483447, 2147352174, 2147155365, 2146893020, 2146499603, 2146040650, 2145516162, 2144926137, 2144270576, 2143483943, 2142631775, 2141714070, 2140665294, 2139616517, 2138436669, 2137191285, 2135814829, 2134438373, 2132930845, 2131357781, 2129719182, 2127949511, 2126179840, 2124279097, 2122312818, 2120215467, 2118118117, 2115889695, 2113595737, 2111236243, 2108811213, 2106255112, 2103633475, 2100946302, 2098193594, 2095309813, 2092426033, 2089411181, 2086330794, 2083184871, 2079907876, 2076565345, 2073222815, 2069749213, 2066144540, 2062539866, 2058804121, 2055068377, 2051201561, 2047203673, 2043205785, 2039142362, 2034947867, 2030687837, 2026362271, 2021971170, 2017514533, 2012926824, 2008339116, 2003620336, 1998836020, 1993986170, 1989070783, 1984024325, 1978977868, 1973800339, 1968557274, 1963248674, 1957874538, 1952434867, 1946929661, 1941358919, 1935657105, 1929889756, 1924122408, 1918223988, 1912260033, 1906230542, 1900135516, 1893909418, 1887683321, 1881391689, 1874968985, 1868546282, 1861992507, 1855373197, 1848753888, 1842003507, 1835187591, 1828306139, 1821359152, 1814346630, 1807268573, 1800124980, 1792850316, 1785575652, 1778235453, 1770829719, 1763358450, 1755756109, 1748153769, 1740485894, 1732686947, 1724888001, 1717023520, 1709093504, 1701032416, 1692971329, 1684844707, 1676652550, 1668394857, 1660071629, 1651682866, 1643228568, 1634708735, 1626123366, 1617472462, 1608756023, 1600039585, 1591192076, 1582344567, 1573365987, 1564387408, 1555343294, 1546233645, 1537058461, 1527817741, 1518511487, 1509205233, 1499767908, 1490330584, 1480827725, 1471259331, 1461625402, 1451925937, 1442160938, 1432395939, 1422565406, 1412669337, 1402707733, 1392680594, 1382653456, 1372560783, 1362402575, 1352178832, 1341889554, 1331600277, 1321245465, 1310825118, 1300339235, 1289853354, 1279301938, 1268684987, 1258002500, 1247320015, 1236571995, 1225758439, 1214944885, 1204065796, 1193121172, 1182111013, 1171100854, 1160025161, 1148949469, 1137808242, 1126601480, 1115329183, 1104056887, 1092719056, 1081381227, 1069977862, 1058508962, 1047040064, 1035505630, 1023971198, 1012371231, 1000705728, 989040227, 977309191, 965578156, 953781586, 941985018, 930122914, 918195275, 906267638, 894340002, 882346831, 870288125, 858229420, 846105180, 833980941, 821856704, 809666931, 797411624, 785221854, 772901013, 760580173, 748259335, 735872961, 723486589, 711100218, 698648312, 686196407, 673678967, 661161529, 648578556, 635995583, 623412612, 610829643, 598181138, 585467099, 572818596, 560104559, 547390524, 534610953, 521831383, 509051815, 496272248, 483427146, 470582046, 457671410, 444826312, 431915679, 419005047, 406094416, 393118251, 380142087, 367165924, 354189762, 341213602, 328171906, 315130212, 302088519, 289046828, 276005137, 262963448, 249856224, 236749001, 223641780, 210534559, 197427340, 184320122, 171147370, 158040154, 144867404, 131760191, 118587443, 105414697, 92241952, 79134744, 65962001, 52789259, 39616519, 26443780, 13271042, 98305, -13139966, -26312700, -39485433, -52658165, -65830895, -79003624, -92110816, -105283543, -118456269, -131628993, -144736180, -157908902, -171016086, -184188806, -197295988, -210403169, -223510348, -236617527, -249724704, -262831880, -275873519, -288915156, -301956793, -314998428, -328040062, -341081694, -354057790, -367033884, -380009977, -392986069, -405962160, -418872713, -431783265, -444693816, -457538830, -470449378, -483294390, -496139400, -508918873, -521698345, -534477815, -547257284, -559971217, -572685148, -585333541, -598047470, -610695861, -623278716, -635861569, -648444420, -661027271, -673544585, -686061897, -698513672, -710965446, -723351683, -735737919, -748124153, -760444851, -772765547, -785086242, -797275864, -809531021, -821720640, -833844723, -845968804, -858092884, -870151427, -882209969, -894202974, -906130442, -918057909, -929985374, -941847302, -953643694, -965440084, -977170937, -988901789, -1000567104, -1012232417, -1023832194, -1035366434, -1046900672, -1058369374, -1069838074, -1081241237, -1092578864, -1103916489, -1115188577, -1126460664, -1137667214, -1148808227, -1159883703, -1170959178, -1181969115, -1192979052, -1203923452, -1214802315, -1225615641, -1236428965, -1247176753, -1257859004, -1268541253, -1279157966, -1289709142, -1300194781, -1310680418, -1321100519, -1331455083, -1341744110, -1352033136, -1362256625, -1372414577, -1382506992, -1392533870, -1402560747, -1412522087, -1422417890, -1432248157, -1442012886, -1451777615, -1461476806, -1471110461, -1480678579, -1490181160, -1499618204, -1509055247, -1518361217, -1527667187, -1536907619, -1546082515, -1555191874, -1564235696, -1573213981, -1582192265, -1591039476, -1599886687, -1608602825, -1617318962, -1625969562, -1634554625, -1643074152, -1651528142, -1659916595, -1668239511, -1676496890, -1684688733, -1692815039, -1700875808, -1708936576, -1716866272, -1724730431, -1732529053, -1740327674, -1747995223, -1755597235, -1763199246, -1770670185, -1778075587, -1785415452, -1792689780, -1799964108, -1807107363, -1814185082, -1821197264, -1828143909, -1835025017, -1841840589, -1848590624, -1855209587, -1861828549, -1868381974, -1874804327, -1881226679, -1887517959, -1893743702, -1899969444, -1906064114, -1912093247, -1918056844, -1923954904, -1929721892, -1935488879, -1941190329, -1946760707, -1952265549, -1957704854, -1963078622, -1968386854, -1973629549, -1978806708, -1983852795, -1988898881, -1993813894, -1998663372, -2003447312, -2008165716, -2012753048, -2017340379, -2021796638, -2026187361, -2030512547, -2034772197, -2038966310, -2043029351, -2047026855, -2051024359, -2054890791, -2058626151, -2062361510, -2065965796, -2069570083, -2073043297, -2076385439, -2079727580, -2083004185, -2086149718, -2089229715, -2092244175, -2095127563, -2098010950, -2100763266, -2103450045, -2106071288, -2108626995, -2111051629, -2113410727, -2115704289, -2117932315, -2120029269, -2122126222, -2124092103, -2125992448, -2127761721, -2129530994, -2131169195, -2132741859, -2134248987, -2135625043, -2137001099, -2138246083, -2139425531, -2140473906, -2141522282, -2142439585, -2143291353, -2144077584, -2144732743, -2145322366, -2145846454, -2146305005, -2146698020, -2146959963, -2147156370, -2147287241, -2147418112, -2147352374, -2147221101, -2147024292, -2146761947, -2146368530, -2145909577, -2145385089, -2144795064, -2144139503, -2143352870, -2142500702, -2141582997, -2140534221, -2139485444, -2138305596, -2137060212, -2135683756, -2134307300, -2132799772, -2131226708, -2129588109, -2127818438, -2126048767, -2124148024, -2122181745, -2120084394, -2117987044, -2115758622, -2113464664, -2111105170, -2108680140, -2106124039, -2103502402, -2100815229, -2098062521, -2095178740, -2092294960, -2089280108, -2086199721, -2083053798, -2079776803, -2076434272, -2073091742, -2069618140, -2066013467, -2062408793, -2058673048, -2054937304, -2051070488, -2047072600, -2043074712, -2039011289, -2034816794, -2030556764, -2026231198, -2021840097, -2017383460, -2012795751, -2008208043, -2003489263, -1998704947, -1993855097, -1988939710, -1983893252, -1978846795, -1973669266, -1968426201, -1963117601, -1957743465, -1952303794, -1946798588, -1941227846, -1935526032, -1929758683, -1923991335, -1918092915, -1912128960, -1906099469, -1900004443, -1893778345, -1887552248, -1881260616, -1874837912, -1868415209, -1861861434, -1855242124, -1848622815, -1841872434, -1835056518, -1828175066, -1821228079, -1814215557, -1807137500, -1799993907, -1792719243, -1785444579, -1778104380, -1770698646, -1763227377, -1755625036, -1748022696, -1740354821, -1732555874, -1724756928, -1716892447, -1708962431, -1700901343, -1692840256, -1684713634, -1676521477, -1668263784, -1659940556, -1651551793, -1643097495, -1634577662, -1625992293, -1617341389, -1608624950, -1599908512, -1591061003, -1582213494, -1573234914, -1564256335, -1555212221, -1546102572, -1536927388, -1527686668, -1518380414, -1509074160, -1499636835, -1490199511, -1480696652, -1471128258, -1461494329, -1451794864, -1442029865, -1432264866, -1422434333, -1412538264, -1402576660, -1392549521, -1382522383, -1372429710, -1362271502, -1352047759, -1341758481, -1331469204, -1321114392, -1310694045, -1300208162, -1289722281, -1279170865, -1268553914, -1257871427, -1247188942, -1236440922, -1225627366, -1214813812, -1203934723, -1192990099, -1181979940, -1170969781, -1159894088, -1148818396, -1137677169, -1126470407, -1115198110, -1103925814, -1092587983, -1081250154, -1069846789, -1058377889, -1046908991, -1035374557, -1023840125, -1012240158, -1000574655, -988909154, -977178118, -965447083, -953650513, -941853945, -929991841, -918064202, -906136565, -894208929, -882215758, -870157052, -858098347, -845974107, -833849868, -821725631, -809535858, -797280551, -785090781, -772769940, -760449100, -748128262, -735741888, -723355516, -710969145, -698517239, -686065334, -673547894, -661030456, -648447483, -635864510, -623281539, -610698570, -598050065, -585336026, -572687523, -559973486, -547259451, -534479880, -521700310, -508920742, -496141175, -483296073, -470450973, -457540337, -444695239, -431784606, -418873974, -405963343, -392987178, -380011014, -367034851, -354058689, -341082529, -328040833, -314999139, -301957446, -288915755, -275874064, -262832375, -249725151, -236617928, -223510707, -210403486, -197296267, -184189049, -171016297, -157909081, -144736331, -131629118, -118456370, -105283624, -92110879, -79003671, -65830928, -52658186, -39485446, -26312707, -13139969 };

void accum32(int n, uint32_t fcw, uint32_t p0, uint32_t *phases) {
    int i = 0;
    uint32_t last = p0;

    while (i < n) {
        last = (last + fcw) & (DDS_PA_MAX - 1);
        *(phases + i++) = last;
    }
}

uint32_t *sincos_lut_addr = (uint32_t*)DDS_LUT_ADDR;

int dsp_init()
{
    memcpy(sincos_lut_addr, sincos_lut, DDS_RAM_SIZE_BITS >> 3); 
    return 0;
}

inline void sincos16(uint32_t phase, int16_t *i, int16_t *q) {
    uint16_t entry = (phase & ((DDS_ROM_NUM_SAMPLES - 1) << DDS_PHASE_SHIFT)) >> DDS_PHASE_SHIFT;
    QUAD_UNPACK(sincos_lut[entry], *i, *q);
}

uint32_t sincos16c(uint32_t fcw, uint32_t *phase) {
    int i = 0;
    uint16_t entry;
    entry = (*phase & ((DDS_ROM_NUM_SAMPLES - 1) << DDS_PHASE_SHIFT)) >> DDS_PHASE_SHIFT;
    *phase = (*phase + fcw) & (DDS_PA_MAX - 1);
    return sincos_lut_addr[entry];
}

uint32_t freq_to_fcw(float freq, float sample_rate) {
    return (uint32_t)(freq / (sample_rate / (DDS_PA_MAX >> 1)));
}
