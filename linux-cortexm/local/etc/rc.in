#!/bin/sh

# "devel" sets up a development environment with an NFS mount.
# "demo1" just repeats a CQ over and over.
image_type="@IMAGE_TYPE@"

mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devpts none /dev/pts
mount -t debugfs none /sys/kernel/debug

ifconfig lo 127.0.0.1


#modprobe snd-dummy
#modprobe g_audio

modprobe whitebox

#modprobe snd-usb-audio

# Charlie user space button.
echo 32 > /sys/class/gpio/export
echo out > /sys/class/gpio/gpio32/direction
echo 1 > /sys/class/gpio/gpio32/value

if [ "$image_type" = "devel" ]; then
    mkdir /mnt
    mount -o nolock,rsize=1024 192.168.220.1:/srv/home /mnt
    ln -s /mnt/whitebox/build/linux-cortexm-1.12.0/A2F/root/usr/bin/gdbserver /usr/bin/gdbserver
fi

if [ "$image_type" = "demo1" ]; then
    while date; do
        whiteboxd
    done
fi

if [ "$image_type" = "demo2" ]; then
    # Run the test suite on startup
    test_adf4351
    test_cmx991
    test_dsp
    test_driver
    test_device
    test_rf
    # Loop over main
    while date; do
        main
    done
fi

if [ "$image_type" = "wifipanel" ]; then
    #echo 8 > /proc/sys/kernel/printk
    modprobe 8188eu #; if [ $? != 0 ]; then reboot; fi
    modprobe -r 8188eu
    modprobe 8188eu
    #insmod /lib/modules/2.6.33-arm1/8188eu.ko
    ifconfig wlan0 up 192.168.1.1
    hostapd /etc/hostapd.conf &
    echo > /var/tmp/udhcpd.leases
    udhcpd /etc/udhcpd.conf
    dnsd -d -c /etc/dnsd.conf
    #main
fi
