#include "whitebox.h"
#include <stdio.h>
#include <string.h>

/*

# Generated using the following Python:

import numpy as np

scale_factor = 1.0
sample_resolution = 16 # in bits

num_samples = 1024
fstep = sample_rate / num_samples
print 'Sample Rate %d kHz, Step Size %.3f Hz' % (sample_rate/1e3, fstep) 


half = scale_factor*pow(2, sample_resolution - 1)
pack = lambda i, q: np.int32(i & 0xffff) | ((q & 0xffff) << 16)
unpack = lambda s: (np.int16(s & 0xffff), np.int16((s >> 16) & 0xffff))

t = np.arange(0, 2*np.pi, (2*np.pi) / num_samples)
theta = 2 * np.pi * fstep * np.arange(num_samples) / sample_rate
i = np.array(np.floor(np.cos(theta)*(half-1)+.5), dtype=np.int16)
assert(sum(i) == 0)
q = np.array(np.floor(np.sin(theta)*(half-1)+.5), dtype=np.int16)
assert(sum(q) == 0)

lut = [pack(a, b) for a, b in zip(i, q)]
lut_str = ["%d" % j for j in lut]
print 'int32_t sincos_lut[] = {', ', '.join(lut_str), '};'

*/

int32_t sincos_lut[] = { 32767, 13205502, 26378237, 39550969, 52723701, 65896432, 79069161, 92241889, 105414616, 118587341, 131694529, 144867252, 157974438, 171147159, 184254342, 197427060, 210534241, 223641421, 236748599, 249790241, 262897417, 275939055, 289046229, 302087865, 315129500, 328171134, 341147231, 354188862, 367164957, 380141050, 393117141, 406027696, 419003785, 431914338, 444759353, 457669902, 470514915, 483359926, 496204936, 509049945, 521829417, 534608888, 547322821, 560036753, 572750684, 585464614, 598113006, 610761398, 623409788, 635992641, 648575493, 661092808, 673610121, 686127434, 698579209, 711030983, 723482756, 735868991, 748255226, 760575923, 772896619, 785151778, 797406936, 809596557, 821786177, 833975795, 846099877, 858158421, 870282500, 882275506, 894268511, 906261514, 918188981, 930050910, 941912839, 953774766, 965505620, 977302009, 988967325, 1000698176, 1012297954, 1023897731, 1035497506, 1047031745, 1058500446, 1069903611, 1081306774, 1092709936, 1104047561, 1115319649, 1126526200, 1137732750, 1148873763, 1160014775, 1171090250, 1182100188, 1193044589, 1203988989, 1214867851, 1225746713, 1236560038, 1247307826, 1257990076, 1268606790, 1279223503, 1289774678, 1300325853, 1310745955, 1321166056, 1331520620, 1341875182, 1352098672, 1362322161, 1372480113, 1382572528, 1392664942, 1402691819, 1412587624, 1422483427, 1432379229, 1442143959, 1451908687, 1461542343, 1471175998, 1480744115, 1490246696, 1499749276, 1509120783, 1518492290, 1527732723, 1536973156, 1546148051, 1555257410, 1564366768, 1573345053, 1582257802, 1591170549, 1599952224, 1608733897, 1617450034, 1626035099, 1634620162, 1643139688, 1651593678, 1659982131, 1668305047, 1676562427, 1684819805, 1692946111, 1701006880, 1709002113, 1716931808, 1724861503, 1732660125, 1740393211, 1748126296, 1755728308, 1763264783, 1770735721, 1778206659, 1785546524, 1792820853, 1800029645, 1807172900, 1814250618, 1821262800, 1828209445, 1835090554, 1841906126, 1848656161, 1855340659, 1861959621, 1868447511, 1874935400, 1881292216, 1887649031, 1893874774, 1900034981, 1906129650, 1912158784, 1918122380, 1924020441, 1929852964, 1935554415, 1941255866, 1946826244, 1952396621, 1957835926, 1963209695, 1968517926, 1973760622, 1978872245, 1983983867, 1988964417, 1993879431, 1998728908, 2003512849, 2008231253, 2012884121, 2017405916, 2021927711, 2026318433, 2030643619, 2034903269, 2039031846, 2043160423, 2047157928, 2051089896, 2054956328, 2058757223, 2062427046, 2066096869, 2069635619, 2073108833, 2076516511, 2079858653, 2083069722, 2086215255, 2089295251, 2092309711, 2095258635, 2098076487, 2100894338, 2103581118, 2106136825, 2108692531, 2111117166, 2113541800, 2115835362, 2117997852, 2120160341, 2122191759, 2124157640, 2126057985, 2127892794, 2129596530, 2131300267, 2132872931, 2134314524, 2135756116, 2137066636, 2138311620, 2139491067, 2140604979, 2141587818, 2142505122, 2143356889, 2144143121, 2144863816, 2145453439, 2145977526, 2146436077, 2146763556, 2147025499, 2147287442, 2147352777, 2147418112, 2147417911, 2147352174, 2147089829, 2146827484, 2146499603, 2146040650, 2145516161, 2144926136, 2144205039, 2143418407, 2142566238, 2141648534, 2140665293, 2139550981, 2138371132, 2137125748, 2135814828, 2134372836, 2132930845, 2131357781, 2129653646, 2127949510, 2126114303, 2124213560, 2122247281, 2120215467, 2118052580, 2115889694, 2113595736, 2111170706, 2108745677, 2106189575, 2103633474, 2100946302, 2098128057, 2095309813, 2092360497, 2089345645, 2086265257, 2083119334, 2079907875, 2076565345, 2073157279, 2069683677, 2066144539, 2062474330, 2058804121, 2055002840, 2051136024, 2047203672, 2043205785, 2039076826, 2034947867, 2030687837, 2026362271, 2021971169, 2017448996, 2012926823, 2008273579, 2003554799, 1998770484, 1993920633, 1989005247, 1984024325, 1978912331, 1973800338, 1968557274, 1963248673, 1957874538, 1952434867, 1946864124, 1941293382, 1935591569, 1929889756, 1924056871, 1918158452, 1912194496, 1906165006, 1900069979, 1893909418, 1887683321, 1881326152, 1874968984, 1868480745, 1861992507, 1855373197, 1848688351, 1841937970, 1835122054, 1828240603, 1821293616, 1814281094, 1807203036, 1800059443, 1792850315, 1785575652, 1778235453, 1770764183, 1763292913, 1755756108, 1748153768, 1740420357, 1732686947, 1724888001, 1716957984, 1709027967, 1701032416, 1692971329, 1684844707, 1676587013, 1668329321, 1660006093, 1651617330, 1643163032, 1634643198, 1626057829, 1617472462, 1608756023, 1599974048, 1591192075, 1582279030, 1573365987, 1564387408, 1555277758, 1546168109, 1536992924, 1527752205, 1518511486, 1509139697, 1499767908, 1490265048, 1480762189, 1471193794, 1461559865, 1451925937, 1442160937, 1432395939, 1422499869, 1412603800, 1402707733, 1392680594, 1382587920, 1372495247, 1362337039, 1352113296, 1341889554, 1331534740, 1321179928, 1310759581, 1300339235, 1289787818, 1279236401, 1268619450, 1258002500, 1247320014, 1236571994, 1225758439, 1214879349, 1204000259, 1193055635, 1182111012, 1171100854, 1160025161, 1148883933, 1137742706, 1126535944, 1115329183, 1104056887, 1092719056, 1081315690, 1069912325, 1058508962, 1047040063, 1035505630, 1023905661, 1012305694, 1000705728, 988974691, 977309191, 965512620, 953781586, 941919481, 930057378, 918195275, 906267638, 894274465, 882281294, 870288124, 858163883, 846105179, 833980941, 821791167, 809601395, 797411624, 785156318, 772901013, 760580173, 748259334, 735872961, 723486588, 711034681, 698582775, 686130870, 673613431, 661095992, 648578555, 635995583, 623412612, 610764106, 598115602, 585467098, 572753060, 560039023, 547324987, 534610952, 521831383, 509051815, 496206712, 483361610, 470516509, 457671410, 444760775, 431915678, 419005047, 406028880, 393118251, 380142086, 367165923, 354189762, 341148065, 328171906, 315130212, 302088519, 289046827, 275939601, 262897911, 249790687, 236749001, 223641779, 210534559, 197427340, 184254586, 171147369, 157974618, 144867404, 131694655, 118587443, 105414696, 92241951, 79069207, 65896464, 52723723, 39550983, 26378243, 13205506, 32769, -13139966, -26312701, -39485433, -52658165, -65830896, -79003625, -92176353, -105349080, -118521805, -131628993, -144801716, -157908902, -171081623, -184188806, -197361524, -210468705, -223575885, -236683063, -249724705, -262831881, -275873519, -288980693, -302022329, -315063964, -328105598, -341081695, -354123326, -367099421, -380075514, -393051605, -405962160, -418938249, -431848802, -444693817, -457604366, -470449379, -483294390, -496139400, -508984409, -521763881, -534543352, -547257285, -559971217, -572685148, -585399078, -598047470, -610695862, -623344252, -635927105, -648509957, -661027272, -673544585, -686061898, -698513673, -710965447, -723417220, -735803455, -748189690, -760510387, -772831083, -785086242, -797341400, -809531021, -821720641, -833910259, -846034341, -858092885, -870216964, -882209970, -894202975, -906195978, -918123445, -929985374, -941847303, -953709230, -965440084, -977236473, -988901789, -1000632640, -1012232418, -1023832195, -1035431970, -1046966209, -1058434910, -1069838075, -1081241238, -1092644400, -1103982025, -1115254113, -1126460664, -1137667214, -1148808227, -1159949239, -1171024714, -1182034652, -1192979053, -1203923453, -1214802315, -1225681177, -1236494502, -1247242290, -1257924540, -1268541254, -1279157967, -1289709142, -1300260317, -1310680419, -1321100520, -1331455084, -1341809646, -1352033136, -1362256625, -1372414577, -1382506992, -1392599406, -1402626283, -1412522088, -1422417891, -1432313693, -1442078423, -1451843151, -1461476807, -1471110462, -1480678579, -1490181160, -1499683740, -1509055247, -1518426754, -1527667187, -1536907620, -1546082515, -1555191874, -1564301232, -1573279517, -1582192266, -1591105013, -1599886688, -1608668361, -1617384498, -1625969563, -1634554626, -1643074152, -1651528142, -1659916595, -1668239511, -1676496891, -1684754269, -1692880575, -1700941344, -1708936577, -1716866272, -1724795967, -1732594589, -1740327675, -1748060760, -1755662772, -1763199247, -1770670185, -1778141123, -1785480988, -1792755317, -1799964109, -1807107364, -1814185082, -1821197264, -1828143909, -1835025018, -1841840590, -1848590625, -1855275123, -1861894085, -1868381975, -1874869864, -1881226680, -1887583495, -1893809238, -1899969445, -1906064114, -1912093248, -1918056844, -1923954905, -1929787428, -1935488879, -1941190330, -1946760708, -1952331085, -1957770390, -1963144159, -1968452390, -1973695086, -1978806709, -1983918331, -1988898881, -1993813895, -1998663372, -2003447313, -2008165717, -2012818585, -2017340380, -2021862175, -2026252897, -2030578083, -2034837733, -2038966310, -2043094887, -2047092392, -2051024360, -2054890792, -2058691687, -2062361510, -2066031333, -2069570083, -2073043297, -2076450975, -2079793117, -2083004186, -2086149719, -2089229715, -2092244175, -2095193099, -2098010951, -2100828802, -2103515582, -2106071289, -2108626995, -2111051630, -2113476264, -2115769826, -2117932316, -2120094805, -2122126223, -2124092104, -2125992449, -2127827258, -2129530994, -2131234731, -2132807395, -2134248988, -2135690580, -2137001100, -2138246084, -2139425531, -2140539443, -2141522282, -2142439586, -2143291353, -2144077585, -2144798280, -2145387903, -2145911990, -2146370541, -2146698020, -2146959963, -2147221906, -2147287241, -2147418112, -2147352375, -2147286638, -2147024293, -2146761948, -2146434067, -2145975114, -2145450625, -2144860600, -2144139503, -2143352871, -2142500702, -2141582998, -2140599757, -2139485445, -2138305596, -2137060212, -2135749292, -2134307300, -2132865309, -2131292245, -2129588110, -2127883974, -2126048767, -2124148024, -2122181745, -2120149931, -2117987044, -2115824158, -2113530200, -2111105170, -2108680141, -2106124039, -2103567938, -2100880766, -2098062521, -2095244277, -2092294961, -2089280109, -2086199721, -2083053798, -2079842339, -2076499809, -2073091743, -2069618141, -2066079003, -2062408794, -2058738585, -2054937304, -2051070488, -2047138136, -2043140249, -2039011290, -2034882331, -2030622301, -2026296735, -2021905633, -2017383460, -2012861287, -2008208043, -2003489263, -1998704948, -1993855097, -1988939711, -1983958789, -1978846795, -1973734802, -1968491738, -1963183137, -1957809002, -1952369331, -1946798588, -1941227846, -1935526033, -1929824220, -1923991335, -1918092916, -1912128960, -1906099470, -1900004443, -1893843882, -1887617785, -1881260616, -1874903448, -1868415209, -1861926971, -1855307661, -1848622815, -1841872434, -1835056518, -1828175067, -1821228080, -1814215558, -1807137500, -1799993907, -1792784779, -1785510116, -1778169917, -1770698647, -1763227377, -1755690572, -1748088232, -1740354821, -1732621411, -1724822465, -1716892448, -1708962431, -1700966880, -1692905793, -1684779171, -1676521477, -1668263785, -1659940557, -1651551794, -1643097496, -1634577662, -1625992293, -1617406926, -1608690487, -1599908512, -1591126539, -1582213494, -1573300451, -1564321872, -1555212222, -1546102573, -1536927388, -1527686669, -1518445950, -1509074161, -1499702372, -1490199512, -1480696653, -1471128258, -1461494329, -1451860401, -1442095401, -1432330403, -1422434333, -1412538264, -1402642197, -1392615058, -1382522384, -1372429711, -1362271503, -1352047760, -1341824018, -1331469204, -1321114392, -1310694045, -1300273699, -1289722282, -1279170865, -1268553914, -1257936964, -1247254478, -1236506458, -1225692903, -1214813813, -1203934723, -1192990099, -1182045476, -1171035318, -1159959625, -1148818397, -1137677170, -1126470408, -1115263647, -1103991351, -1092653520, -1081250154, -1069846789, -1058443426, -1046974527, -1035440094, -1023840125, -1012240158, -1000640192, -988909155, -977243655, -965447084, -953716050, -941853945, -929991842, -918129739, -906202102, -894208929, -882215758, -870222588, -858098347, -846039643, -833915405, -821725631, -809535859, -797346088, -785090782, -772835477, -760514637, -748193798, -735807425, -723421052, -710969145, -698517239, -686065334, -673547895, -661030456, -648513019, -635930047, -623347076, -610698570, -598050066, -585401562, -572687524, -559973487, -547259451, -534545416, -521765847, -508986279, -496141176, -483296074, -470450973, -457605874, -444695239, -431850142, -418939511, -405963344, -393052715, -380076550, -367100387, -354124226, -341082529, -328106370, -315064676, -302022983, -288981291, -275874065, -262832375, -249725151, -236683465, -223576243, -210469023, -197361804, -184189050, -171081833, -157909082, -144801868, -131629119, -118521907, -105349160, -92176415, -79003671, -65830928, -52658187, -39485447, -26312707, -13139970 };

void accum32(int n, uint32_t fcw, uint32_t p0, uint32_t *phases) {
    int i = 0;
    uint32_t last = p0;

    while (i < n) {
        last = (last + fcw) & (DDS_PA_MAX - 1);
        *(phases + i++) = last;
    }
}

uint32_t *sincos_lut_addr = &sincos_lut; //(uint32_t*)DDS_LUT_ADDR;

int dsp_init()
{
    //memcpy(sincos_lut_addr, sincos_lut, DDS_RAM_SIZE_BITS >> 3); 
    return 0;
}

void sincos16(uint32_t fcw, uint32_t *phase, int16_t *i, int16_t *q) {
    uint16_t entry;
    int16_t cq, sq;
    entry = (*phase & ((DDS_ROM_NUM_SAMPLES - 1) << DDS_PHASE_SHIFT)) >> DDS_PHASE_SHIFT;
    QUAD_UNPACK(sincos_lut_addr[entry],
            *i, cq);
    QUAD_UNPACK(sincos_lut_addr[(entry + DDS_PI_OVER_4) & (DDS_ROM_NUM_SAMPLES - 1)],
            *q, sq);
    *phase = (*phase + fcw) & (DDS_PA_MAX - 1);
}

uint32_t sincos16c(uint32_t fcw, uint32_t *phase) {
    int i = 0;
    uint16_t entry;
    int16_t ci, cq, si, sq;
    entry = (*phase & ((DDS_ROM_NUM_SAMPLES - 1) << DDS_PHASE_SHIFT)) >> DDS_PHASE_SHIFT;
    QUAD_UNPACK(sincos_lut_addr[entry],
            ci, cq);
    QUAD_UNPACK(sincos_lut_addr[(entry + DDS_PI_OVER_4) & (DDS_ROM_NUM_SAMPLES - 1)],
            si, sq);
    *phase = (*phase + fcw) & (DDS_PA_MAX - 1);
    return QUAD_PACK(ci, si);
}

uint32_t freq_to_fcw(float freq, float sample_rate) {
    return (uint32_t)(freq / (sample_rate / (DDS_PA_MAX >> 1)));
}

void awgn(int16_t *s) {
    *s = rand() % (1 << 16 - 1);
}
