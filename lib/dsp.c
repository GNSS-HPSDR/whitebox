#include "whitebox.h"
#include <stdio.h>

int16_t cos_lut[] = {
29204, 29204, 29202, 29200, 29196, 29191, 29185, 29178, 29169, 29160, 29150, 29138, 29125, 29112, 29097, 29081, 29064, 29046, 29027, 29006, 28985, 28962, 28939, 28914, 28888, 28862, 28834, 28805, 28775, 28743, 28711, 28678, 28643, 28608, 28571, 28534, 28495, 28455, 28414, 28372, 28329, 28285, 28240, 28194, 28147, 28098, 28049, 27998, 27947, 27894, 27841, 27786, 27731, 27674, 27616, 27557, 27497, 27436, 27375, 27312, 27248, 27183, 27117, 27050, 26981, 26912, 26842, 26771, 26699, 26626, 26552, 26477, 26401, 26323, 26245, 26166, 26086, 26005, 25923, 25840, 25756, 25671, 25585, 25498, 25411, 25322, 25232, 25141, 25050, 24957, 24863, 24769, 24674, 24577, 24480, 24382, 24283, 24183, 24082, 23980, 23877, 23774, 23669, 23564, 23457, 23350, 23242, 23133, 23023, 22913, 22801, 22689, 22575, 22461, 22346, 22231, 22114, 21997, 21878, 21759, 21639, 21518, 21397, 21275, 21151, 21027, 20903, 20777, 20651, 20524, 20396, 20267, 20138, 20008, 19877, 19745, 19613, 19480, 19346, 19211, 19076, 18940, 18803, 18665, 18527, 18388, 18249, 18109, 17968, 17826, 17684, 17541, 17397, 17253, 17108, 16963, 16816, 16670, 16522, 16374, 16225, 16076, 15926, 15776, 15625, 15473, 15321, 15168, 15014, 14860, 14706, 14551, 14395, 14239, 14082, 13925, 13767, 13609, 13450, 13291, 13131, 12971, 12810, 12649, 12487, 12325, 12162, 11999, 11835, 11671, 11507, 11342, 11176, 11011, 10844, 10678, 10511, 10343, 10176, 10008, 9839, 9670, 9501, 9331, 9161, 8991, 8820, 8649, 8478, 8306, 8134, 7962, 7790, 7617, 7444, 7270, 7096, 6923, 6748, 6574, 6399, 6224, 6049, 5874, 5698, 5522, 5346, 5170, 4993, 4817, 4640, 4463, 4286, 4108, 3931, 3753, 3575, 3397, 3219, 3041, 2863, 2685, 2506, 2328, 2149, 1970, 1791, 1612, 1433, 1254, 1075, 896, 717, 538, 359, 180, 1, -179, -358, -537, -716, -895, -1074, -1253, -1432, -1611, -1790, -1969, -2148, -2327, -2505, -2684, -2862, -3040, -3218, -3396, -3574, -3752, -3930, -4107, -4285, -4462, -4639, -4816, -4992, -5169, -5345, -5521, -5697, -5873, -6048, -6223, -6398, -6573, -6747, -6922, -7095, -7269, -7443, -7616, -7789, -7961, -8133, -8305, -8477, -8648, -8819, -8990, -9160, -9330, -9500, -9669, -9838, -10007, -10175, -10342, -10510, -10677, -10843, -11010, -11175, -11341, -11506, -11670, -11834, -11998, -12161, -12324, -12486, -12648, -12809, -12970, -13130, -13290, -13449, -13608, -13766, -13924, -14081, -14238, -14394, -14550, -14705, -14859, -15013, -15167, -15320, -15472, -15624, -15775, -15925, -16075, -16224, -16373, -16521, -16669, -16815, -16962, -17107, -17252, -17396, -17540, -17683, -17825, -17967, -18108, -18248, -18387, -18526, -18664, -18802, -18939, -19075, -19210, -19345, -19479, -19612, -19744, -19876, -20007, -20137, -20266, -20395, -20523, -20650, -20776, -20902, -21026, -21150, -21274, -21396, -21517, -21638, -21758, -21877, -21996, -22113, -22230, -22345, -22460, -22574, -22688, -22800, -22912, -23022, -23132, -23241, -23349, -23456, -23563, -23668, -23773, -23876, -23979, -24081, -24182, -24282, -24381, -24479, -24576, -24673, -24768, -24862, -24956, -25049, -25140, -25231, -25321, -25410, -25497, -25584, -25670, -25755, -25839, -25922, -26004, -26085, -26165, -26244, -26322, -26400, -26476, -26551, -26625, -26698, -26770, -26841, -26911, -26980, -27049, -27116, -27182, -27247, -27311, -27374, -27435, -27496, -27556, -27615, -27673, -27730, -27785, -27840, -27893, -27946, -27997, -28048, -28097, -28146, -28193, -28239, -28284, -28328, -28371, -28413, -28454, -28494, -28533, -28570, -28607, -28642, -28677, -28710, -28742, -28774, -28804, -28833, -28861, -28887, -28913, -28938, -28961, -28984, -29005, -29026, -29045, -29063, -29080, -29096, -29111, -29124, -29137, -29149, -29159, -29168, -29177, -29184, -29190, -29195, -29199, -29201, -29203, -29204, -29203, -29201, -29199, -29195, -29190, -29184, -29177, -29168, -29159, -29149, -29137, -29124, -29111, -29096, -29080, -29063, -29045, -29026, -29005, -28984, -28961, -28938, -28913, -28887, -28861, -28833, -28804, -28774, -28742, -28710, -28677, -28642, -28607, -28570, -28533, -28494, -28454, -28413, -28371, -28328, -28284, -28239, -28193, -28146, -28097, -28048, -27997, -27946, -27893, -27840, -27785, -27730, -27673, -27615, -27556, -27496, -27435, -27374, -27311, -27247, -27182, -27116, -27049, -26980, -26911, -26841, -26770, -26698, -26625, -26551, -26476, -26400, -26322, -26244, -26165, -26085, -26004, -25922, -25839, -25755, -25670, -25584, -25497, -25410, -25321, -25231, -25140, -25049, -24956, -24862, -24768, -24673, -24576, -24479, -24381, -24282, -24182, -24081, -23979, -23876, -23773, -23668, -23563, -23456, -23349, -23241, -23132, -23022, -22912, -22800, -22688, -22574, -22460, -22345, -22230, -22113, -21996, -21877, -21758, -21638, -21517, -21396, -21274, -21150, -21026, -20902, -20776, -20650, -20523, -20395, -20266, -20137, -20007, -19876, -19744, -19612, -19479, -19345, -19210, -19075, -18939, -18802, -18664, -18526, -18387, -18248, -18108, -17967, -17825, -17683, -17540, -17396, -17252, -17107, -16962, -16815, -16669, -16521, -16373, -16224, -16075, -15925, -15775, -15624, -15472, -15320, -15167, -15013, -14859, -14705, -14550, -14394, -14238, -14081, -13924, -13766, -13608, -13449, -13290, -13130, -12970, -12809, -12648, -12486, -12324, -12161, -11998, -11834, -11670, -11506, -11341, -11175, -11010, -10843, -10677, -10510, -10342, -10175, -10007, -9838, -9669, -9500, -9330, -9160, -8990, -8819, -8648, -8477, -8305, -8133, -7961, -7789, -7616, -7443, -7269, -7095, -6922, -6747, -6573, -6398, -6223, -6048, -5873, -5697, -5521, -5345, -5169, -4992, -4816, -4639, -4462, -4285, -4107, -3930, -3752, -3574, -3396, -3218, -3040, -2862, -2684, -2505, -2327, -2148, -1969, -1790, -1611, -1432, -1253, -1074, -895, -716, -537, -358, -179, 0, 180, 359, 538, 717, 896, 1075, 1254, 1433, 1612, 1791, 1970, 2149, 2328, 2506, 2685, 2863, 3041, 3219, 3397, 3575, 3753, 3931, 4108, 4286, 4463, 4640, 4817, 4993, 5170, 5346, 5522, 5698, 5874, 6049, 6224, 6399, 6574, 6748, 6923, 7096, 7270, 7444, 7617, 7790, 7962, 8134, 8306, 8478, 8649, 8820, 8991, 9161, 9331, 9501, 9670, 9839, 10008, 10176, 10343, 10511, 10678, 10844, 11011, 11176, 11342, 11507, 11671, 11835, 11999, 12162, 12325, 12487, 12649, 12810, 12971, 13131, 13291, 13450, 13609, 13767, 13925, 14082, 14239, 14395, 14551, 14706, 14860, 15014, 15168, 15321, 15473, 15625, 15776, 15926, 16076, 16225, 16374, 16522, 16670, 16816, 16963, 17108, 17253, 17397, 17541, 17684, 17826, 17968, 18109, 18249, 18388, 18527, 18665, 18803, 18940, 19076, 19211, 19346, 19480, 19613, 19745, 19877, 20008, 20138, 20267, 20396, 20524, 20651, 20777, 20903, 21027, 21151, 21275, 21397, 21518, 21639, 21759, 21878, 21997, 22114, 22231, 22346, 22461, 22575, 22689, 22801, 22913, 23023, 23133, 23242, 23350, 23457, 23564, 23669, 23774, 23877, 23980, 24082, 24183, 24283, 24382, 24480, 24577, 24674, 24769, 24863, 24957, 25050, 25141, 25232, 25322, 25411, 25498, 25585, 25671, 25756, 25840, 25923, 26005, 26086, 26166, 26245, 26323, 26401, 26477, 26552, 26626, 26699, 26771, 26842, 26912, 26981, 27050, 27117, 27183, 27248, 27312, 27375, 27436, 27497, 27557, 27616, 27674, 27731, 27786, 27841, 27894, 27947, 27998, 28049, 28098, 28147, 28194, 28240, 28285, 28329, 28372, 28414, 28455, 28495, 28534, 28571, 28608, 28643, 28678, 28711, 28743, 28775, 28805, 28834, 28862, 28888, 28914, 28939, 28962, 28985, 29006, 29027, 29046, 29064, 29081, 29097, 29112, 29125, 29138, 29150, 29160, 29169, 29178, 29185, 29191, 29196, 29200, 29202, 29204
};

int16_t sin_lut[] = {
0, 180, 359, 538, 717, 896, 1075, 1254, 1433, 1612, 1791, 1970, 2149, 2328, 2506, 2685, 2863, 3041, 3219, 3397, 3575, 3753, 3931, 4108, 4286, 4463, 4640, 4817, 4993, 5170, 5346, 5522, 5698, 5874, 6049, 6224, 6399, 6574, 6748, 6923, 7096, 7270, 7444, 7617, 7790, 7962, 8134, 8306, 8478, 8649, 8820, 8991, 9161, 9331, 9501, 9670, 9839, 10008, 10176, 10343, 10511, 10678, 10844, 11011, 11176, 11342, 11507, 11671, 11835, 11999, 12162, 12325, 12487, 12649, 12810, 12971, 13131, 13291, 13450, 13609, 13767, 13925, 14082, 14239, 14395, 14551, 14706, 14860, 15014, 15168, 15321, 15473, 15625, 15776, 15926, 16076, 16225, 16374, 16522, 16670, 16816, 16963, 17108, 17253, 17397, 17541, 17684, 17826, 17968, 18109, 18249, 18388, 18527, 18665, 18803, 18940, 19076, 19211, 19346, 19480, 19613, 19745, 19877, 20008, 20138, 20267, 20396, 20524, 20651, 20777, 20903, 21027, 21151, 21275, 21397, 21518, 21639, 21759, 21878, 21997, 22114, 22231, 22346, 22461, 22575, 22689, 22801, 22913, 23023, 23133, 23242, 23350, 23457, 23564, 23669, 23774, 23877, 23980, 24082, 24183, 24283, 24382, 24480, 24577, 24674, 24769, 24863, 24957, 25050, 25141, 25232, 25322, 25411, 25498, 25585, 25671, 25756, 25840, 25923, 26005, 26086, 26166, 26245, 26323, 26401, 26477, 26552, 26626, 26699, 26771, 26842, 26912, 26981, 27050, 27117, 27183, 27248, 27312, 27375, 27436, 27497, 27557, 27616, 27674, 27731, 27786, 27841, 27894, 27947, 27998, 28049, 28098, 28147, 28194, 28240, 28285, 28329, 28372, 28414, 28455, 28495, 28534, 28571, 28608, 28643, 28678, 28711, 28743, 28775, 28805, 28834, 28862, 28888, 28914, 28939, 28962, 28985, 29006, 29027, 29046, 29064, 29081, 29097, 29112, 29125, 29138, 29150, 29160, 29169, 29178, 29185, 29191, 29196, 29200, 29202, 29204, 29204, 29204, 29202, 29200, 29196, 29191, 29185, 29178, 29169, 29160, 29150, 29138, 29125, 29112, 29097, 29081, 29064, 29046, 29027, 29006, 28985, 28962, 28939, 28914, 28888, 28862, 28834, 28805, 28775, 28743, 28711, 28678, 28643, 28608, 28571, 28534, 28495, 28455, 28414, 28372, 28329, 28285, 28240, 28194, 28147, 28098, 28049, 27998, 27947, 27894, 27841, 27786, 27731, 27674, 27616, 27557, 27497, 27436, 27375, 27312, 27248, 27183, 27117, 27050, 26981, 26912, 26842, 26771, 26699, 26626, 26552, 26477, 26401, 26323, 26245, 26166, 26086, 26005, 25923, 25840, 25756, 25671, 25585, 25498, 25411, 25322, 25232, 25141, 25050, 24957, 24863, 24769, 24674, 24577, 24480, 24382, 24283, 24183, 24082, 23980, 23877, 23774, 23669, 23564, 23457, 23350, 23242, 23133, 23023, 22913, 22801, 22689, 22575, 22461, 22346, 22231, 22114, 21997, 21878, 21759, 21639, 21518, 21397, 21275, 21151, 21027, 20903, 20777, 20651, 20524, 20396, 20267, 20138, 20008, 19877, 19745, 19613, 19480, 19346, 19211, 19076, 18940, 18803, 18665, 18527, 18388, 18249, 18109, 17968, 17826, 17684, 17541, 17397, 17253, 17108, 16963, 16816, 16670, 16522, 16374, 16225, 16076, 15926, 15776, 15625, 15473, 15321, 15168, 15014, 14860, 14706, 14551, 14395, 14239, 14082, 13925, 13767, 13609, 13450, 13291, 13131, 12971, 12810, 12649, 12487, 12325, 12162, 11999, 11835, 11671, 11507, 11342, 11176, 11011, 10844, 10678, 10511, 10343, 10176, 10008, 9839, 9670, 9501, 9331, 9161, 8991, 8820, 8649, 8478, 8306, 8134, 7962, 7790, 7617, 7444, 7270, 7096, 6923, 6748, 6574, 6399, 6224, 6049, 5874, 5698, 5522, 5346, 5170, 4993, 4817, 4640, 4463, 4286, 4108, 3931, 3753, 3575, 3397, 3219, 3041, 2863, 2685, 2506, 2328, 2149, 1970, 1791, 1612, 1433, 1254, 1075, 896, 717, 538, 359, 180, 1, -179, -358, -537, -716, -895, -1074, -1253, -1432, -1611, -1790, -1969, -2148, -2327, -2505, -2684, -2862, -3040, -3218, -3396, -3574, -3752, -3930, -4107, -4285, -4462, -4639, -4816, -4992, -5169, -5345, -5521, -5697, -5873, -6048, -6223, -6398, -6573, -6747, -6922, -7095, -7269, -7443, -7616, -7789, -7961, -8133, -8305, -8477, -8648, -8819, -8990, -9160, -9330, -9500, -9669, -9838, -10007, -10175, -10342, -10510, -10677, -10843, -11010, -11175, -11341, -11506, -11670, -11834, -11998, -12161, -12324, -12486, -12648, -12809, -12970, -13130, -13290, -13449, -13608, -13766, -13924, -14081, -14238, -14394, -14550, -14705, -14859, -15013, -15167, -15320, -15472, -15624, -15775, -15925, -16075, -16224, -16373, -16521, -16669, -16815, -16962, -17107, -17252, -17396, -17540, -17683, -17825, -17967, -18108, -18248, -18387, -18526, -18664, -18802, -18939, -19075, -19210, -19345, -19479, -19612, -19744, -19876, -20007, -20137, -20266, -20395, -20523, -20650, -20776, -20902, -21026, -21150, -21274, -21396, -21517, -21638, -21758, -21877, -21996, -22113, -22230, -22345, -22460, -22574, -22688, -22800, -22912, -23022, -23132, -23241, -23349, -23456, -23563, -23668, -23773, -23876, -23979, -24081, -24182, -24282, -24381, -24479, -24576, -24673, -24768, -24862, -24956, -25049, -25140, -25231, -25321, -25410, -25497, -25584, -25670, -25755, -25839, -25922, -26004, -26085, -26165, -26244, -26322, -26400, -26476, -26551, -26625, -26698, -26770, -26841, -26911, -26980, -27049, -27116, -27182, -27247, -27311, -27374, -27435, -27496, -27556, -27615, -27673, -27730, -27785, -27840, -27893, -27946, -27997, -28048, -28097, -28146, -28193, -28239, -28284, -28328, -28371, -28413, -28454, -28494, -28533, -28570, -28607, -28642, -28677, -28710, -28742, -28774, -28804, -28833, -28861, -28887, -28913, -28938, -28961, -28984, -29005, -29026, -29045, -29063, -29080, -29096, -29111, -29124, -29137, -29149, -29159, -29168, -29177, -29184, -29190, -29195, -29199, -29201, -29203, -29204, -29203, -29201, -29199, -29195, -29190, -29184, -29177, -29168, -29159, -29149, -29137, -29124, -29111, -29096, -29080, -29063, -29045, -29026, -29005, -28984, -28961, -28938, -28913, -28887, -28861, -28833, -28804, -28774, -28742, -28710, -28677, -28642, -28607, -28570, -28533, -28494, -28454, -28413, -28371, -28328, -28284, -28239, -28193, -28146, -28097, -28048, -27997, -27946, -27893, -27840, -27785, -27730, -27673, -27615, -27556, -27496, -27435, -27374, -27311, -27247, -27182, -27116, -27049, -26980, -26911, -26841, -26770, -26698, -26625, -26551, -26476, -26400, -26322, -26244, -26165, -26085, -26004, -25922, -25839, -25755, -25670, -25584, -25497, -25410, -25321, -25231, -25140, -25049, -24956, -24862, -24768, -24673, -24576, -24479, -24381, -24282, -24182, -24081, -23979, -23876, -23773, -23668, -23563, -23456, -23349, -23241, -23132, -23022, -22912, -22800, -22688, -22574, -22460, -22345, -22230, -22113, -21996, -21877, -21758, -21638, -21517, -21396, -21274, -21150, -21026, -20902, -20776, -20650, -20523, -20395, -20266, -20137, -20007, -19876, -19744, -19612, -19479, -19345, -19210, -19075, -18939, -18802, -18664, -18526, -18387, -18248, -18108, -17967, -17825, -17683, -17540, -17396, -17252, -17107, -16962, -16815, -16669, -16521, -16373, -16224, -16075, -15925, -15775, -15624, -15472, -15320, -15167, -15013, -14859, -14705, -14550, -14394, -14238, -14081, -13924, -13766, -13608, -13449, -13290, -13130, -12970, -12809, -12648, -12486, -12324, -12161, -11998, -11834, -11670, -11506, -11341, -11175, -11010, -10843, -10677, -10510, -10342, -10175, -10007, -9838, -9669, -9500, -9330, -9160, -8990, -8819, -8648, -8477, -8305, -8133, -7961, -7789, -7616, -7443, -7269, -7095, -6922, -6747, -6573, -6398, -6223, -6048, -5873, -5697, -5521, -5345, -5169, -4992, -4816, -4639, -4462, -4285, -4107, -3930, -3752, -3574, -3396, -3218, -3040, -2862, -2684, -2505, -2327, -2148, -1969, -1790, -1611, -1432, -1253, -1074, -895, -716, -537, -358, -179
};

void accum32(int n, uint32_t fcw, uint32_t p0, uint32_t *phases) {
    int i = 0;
    uint32_t last = p0;

    while (i < n) {
        last = (last + fcw) & (DDS_PA_MAX - 1);
        *(phases + i++) = last;
    }
}

inline void sincos16(uint32_t phase, int16_t *i, int16_t *q) {
    uint16_t entry = (phase & ((DDS_ROM_NUM_SAMPLES - 1) << DDS_PHASE_SHIFT)) >> DDS_PHASE_SHIFT;
    //printf("%08x\n", entry);
    *i = 0;//cos_lut[entry];
    //*q = 0;//sin_lut[entry];
}

uint32_t sincos16c(int n, uint32_t fcw, uint32_t p0, uint32_t *c) {
    int i;
    int16_t re = 0, im = 0;
    uint16_t entry;
    uint32_t phase = p0;
    for (i = 0; i < n; ++i) {
        phase = (phase + fcw) & (DDS_PA_MAX - 1);
        entry = (phase & ((DDS_ROM_NUM_SAMPLES - 1) << DDS_PHASE_SHIFT)) >> DDS_PHASE_SHIFT;
        //re = cos_lut[entry];//0;
        //im = sin_lut[entry];//0;
        *(c+i) = ((uint32_t)im << 16) | (uint32_t)re;
    }
    return phase;
}

uint32_t freq_to_fcw(float freq, float sample_rate) {
    return (uint32_t)(freq / (sample_rate / DDS_PA_MAX));
}
